<Window x:Class="N.I.C.E.___Nextspace_Intelligent_Combo_Evaluator.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="clr-namespace:N.I.C.E.___Nextspace_Intelligent_Combo_Evaluator.ViewModel"
        mc:Ignorable="d"
        Title="N.I.C.E. - Nextspace Intelligent Combo Evaluator" 
        WindowState="Maximized" WindowStartupLocation="CenterScreen"
        MinWidth="1280" MinHeight="720"
        UseLayoutRounding="True">

    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis"/>
        <Style TargetType="TextBlock" x:Key="HeaderStyle">
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="#333"/>
            <Setter Property="Margin" Value="0,15,0,5"/>
        </Style>
        <Style TargetType="Button" x:Key="ComputeButtonStyle">
            <Setter Property="Background" Value="#007ACC"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="FontSize" Value="16"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Content" Value="COMPUTE"/>
            <Style.Triggers>
                <DataTrigger Binding="{Binding IsBusy}" Value="True">
                    <Setter Property="Background" Value="#D9534F"/>
                    <Setter Property="Content" Value="ABORT"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>
        <Style TargetType="Button" x:Key="NiceButtonStyle">
            <Setter Property="Background" Value="#007ACC"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="FontSize" Value="16"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Content" Value="VIEW COMPUTATION DETAILS"/>
            
        </Style>
    </Window.Resources>


    <Grid>
        <DockPanel>
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="*"/>
                    
                </Grid.RowDefinitions>

                <Grid Grid.Row="0">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="340"/>
                    </Grid.ColumnDefinitions>

                    <Grid Grid.Column="0" Margin="10">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <Grid Grid.Row="0" Margin="0,0,0,10">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <Button Grid.Column="0" 
            Width="35" Height="35" 
            Margin="0,0,8,0" 
            VerticalAlignment="Center"
            Background="Transparent"
            BorderBrush="#DDD"
            BorderThickness="1"
            Cursor="Hand"
            Command="{Binding OpenAboutCommand}"
            ToolTip="About N.I.C.E. &amp; Support">
                                <Button.Resources>
                                    <Style TargetType="Border">
                                        <Setter Property="CornerRadius" Value="18"/>
                                    </Style>
                                </Button.Resources>
                                <TextBlock Text="?" FontSize="16" FontWeight="Bold" Foreground="#888" VerticalAlignment="Center" HorizontalAlignment="Center"/>
                            </Button>

                            <TextBox Grid.Column="1" 
             Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}" 
             Padding="5" 
             VerticalContentAlignment="Center" 
             FontSize="14" 
             Tag="Search by Name or Index..."/>

                            <StackPanel Grid.Column="2" Orientation="Horizontal" Margin="10,0,0,0" IsEnabled="{Binding IsInteractionEnabled}">
                                <Button Command="{Binding OpenTimCommand}" Padding="15,5" Margin="0,0,5,0" Background="#F8F9FA">
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="🛠" Margin="0,0,5,0"/>
                                        <TextBlock Text="Open T.I.M" FontWeight="Bold"/>
                                    </StackPanel>
                                </Button>
                                <Button Command="{Binding OpenTamCommand}" Padding="15,5" Background="#F8F9FA">
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="📊" Margin="0,0,5,0"/>
                                        <TextBlock Text="Open T.A.M" FontWeight="Bold"/>
                                    </StackPanel>
                                </Button>
                            </StackPanel>
                        </Grid>

                        <DataGrid Grid.Row="1" ItemsSource="{Binding FilteredTagsView}" AutoGenerateColumns="False" 
                          CanUserSortColumns="True" IsReadOnly="False" GridLinesVisibility="Horizontal"
                          BorderThickness="1" BorderBrush="#CCC">



                            <DataGrid.Columns>
                                <DataGridTextColumn Header="ID" Binding="{Binding Index}" Width="40" IsReadOnly="True"/>

                                <DataGridTemplateColumn Header="Name" Width="200" SortMemberPath="Name" IsReadOnly="True">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding Name}" ToolTip="{Binding Description}" Padding="5,0" FontWeight="SemiBold" VerticalAlignment="Center"/>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>

                                <DataGridTextColumn Header="Description" Binding="{Binding Description}" Width="*" IsReadOnly="True">
                                    <DataGridTextColumn.ElementStyle>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="TextTrimming" Value="CharacterEllipsis"/>
                                            <Setter Property="Foreground" Value="Gray"/>
                                            <Setter Property="VerticalAlignment" Value="Center"/>
                                        </Style>
                                    </DataGridTextColumn.ElementStyle>
                                </DataGridTextColumn>

                                <DataGridTextColumn Header="Rarity" Binding="{Binding Rarity}" Width="80" IsReadOnly="True"/>

                                <DataGridTextColumn Header="Categories" Binding="{Binding Categories}" Width="150" IsReadOnly="True"/>

                                <DataGridTemplateColumn Header="Controversial" Width="100" SortMemberPath="IsControversial" IsReadOnly="True">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <TextBlock x:Name="Icon" 
                                                Text="✔" 
                                                Foreground="Green" 
                                                FontWeight="Bold" 
                                                FontSize="16" 
                                                HorizontalAlignment="Center" 
                                                VerticalAlignment="Center"/>

                                            <DataTemplate.Triggers>
                                                <DataTrigger Binding="{Binding IsControversial}" Value="False">
                                                    <Setter TargetName="Icon" Property="Text" Value="✖"/>
                                                    <Setter TargetName="Icon" Property="Foreground" Value="Red"/>
                                                </DataTrigger>
                                            </DataTemplate.Triggers>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>

                                <DataGridTemplateColumn Header="Mission" Width="90" SortMemberPath="IsStoryMission" IsReadOnly="True">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <TextBlock x:Name="Icon" 
                                                Text="✔" 
                                                Foreground="Green" 
                                                FontWeight="Bold" 
                                                FontSize="16" 
                                                HorizontalAlignment="Center" 
                                                VerticalAlignment="Center"/>

                                            <DataTemplate.Triggers>
                                                <DataTrigger Binding="{Binding IsStoryMission}" Value="False">
                                                    <Setter TargetName="Icon" Property="Text" Value="✖"/>
                                                    <Setter TargetName="Icon" Property="Foreground" Value="Red"/>
                                                </DataTrigger>
                                            </DataTemplate.Triggers>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>

                                <DataGridTextColumn Header="Max Potential" Binding="{Binding MaxPotentialScore, StringFormat=N0}" Width="90" IsReadOnly="True">
                                    <DataGridTextColumn.ElementStyle>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="HorizontalAlignment" Value="Right"/>
                                        </Style>
                                    </DataGridTextColumn.ElementStyle>
                                </DataGridTextColumn>

                                <DataGridTemplateColumn Header="Include" Width="60" SortMemberPath="Include">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <CheckBox IsChecked="{Binding Include, UpdateSourceTrigger=PropertyChanged}" 
                                            IsEnabled="{Binding DataContext.IsInteractionEnabled, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                            HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                            </DataGrid.Columns>
                        </DataGrid>
                    </Grid>

                    <Border Grid.Column="1" Background="#F4F4F4" BorderBrush="#CCC" BorderThickness="1,0,0,0" Padding="15" Margin="0,0,0,10">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="*"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            <ScrollViewer Grid.Row="0" VerticalScrollBarVisibility="Auto">
                                <StackPanel IsEnabled="{Binding IsInteractionEnabled}">
                                    <TextBlock Text="SELECTION FILTERS" FontSize="18" FontWeight="Black" Margin="0,0,0,5" HorizontalAlignment="Center"/>
                                    <TextBlock FontSize="9" Foreground="Gray" Width="277">
                                    <Run Text="(uncheck to remove from calculation — currently "/>
                                    <Run Text="{Binding SelectedTagsCount, Mode=OneWay}" FontWeight="Bold" Foreground="#007ACC"/>
                                    <Run Text=" tags selected)"/>
                                    </TextBlock>
                                    <UniformGrid Columns="2" Margin="0,15,0,10">
                                        <Button Command="{Binding SelectAllVisibleCommand}" Content="Select All" Padding="5" Margin="0,0,2,0" FontSize="11"/>
                                        <Button Command="{Binding DeselectAllVisibleCommand}" Content="Deselect All" Padding="5" Margin="2,0,0,0" FontSize="11"/>
                                    </UniformGrid>
                                    <TextBlock Text="Special Tags" Style="{StaticResource HeaderStyle}"/>
                                    <CheckBox Content="Include Controversial" IsChecked="{Binding IncludeControversial, Mode=TwoWay}" Margin="0,2"/>
                                    <CheckBox Content="Include Story Missions" IsChecked="{Binding IncludeStoryMission, Mode=TwoWay}" Margin="0,2"/>

                                    <Separator Margin="0,15"/>

                                    <TextBlock Text="Rarity" Style="{StaticResource HeaderStyle}"/>
                                    <Border BorderBrush="#DDD" BorderThickness="1" Background="White" Height="120" Margin="0,0,0,10">
                                        <ScrollViewer VerticalScrollBarVisibility="Auto">
                                            <ItemsControl ItemsSource="{Binding RarityBatchSelectors}">
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <CheckBox Content="{Binding Name}" IsChecked="{Binding IsSelected}" Margin="8,4"/>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </ScrollViewer>
                                    </Border>

                                    <TextBlock Text="Categories" Style="{StaticResource HeaderStyle}"/>
                                    <Border BorderBrush="#DDD" BorderThickness="1" Background="White" Height="150">
                                        <ScrollViewer VerticalScrollBarVisibility="Auto">
                                            <ItemsControl ItemsSource="{Binding CategoryBatchSelectors}">
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <CheckBox Content="{Binding Name}" IsChecked="{Binding IsSelected}" Margin="8,4"/>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </ScrollViewer>
                                    </Border>

                                    <Button Command="{Binding ResetFiltersCommand}" Content="Reset all filters" Margin="0,10,0,0" Padding="5"/>
                                    <Separator Margin="0,20"/>
                                    <TextBlock Text="Solver Settings" Style="{StaticResource HeaderStyle}"/>
                                    <Separator Margin="0,0,0,20"/>
                                    <StackPanel Margin="0,0,0,15">
                                        <DockPanel LastChildFill="True">
                                            <TextBlock Text="COMBO SIZE" FontSize="11" FontWeight="Bold" Foreground="#666"/>
                                            <TextBlock Text="{Binding ComboSize}" FontWeight="Black" Foreground="#007ACC" HorizontalAlignment="Right"/>
                                        </DockPanel>
                                        <Slider Minimum="2" Maximum="5" TickFrequency="1" IsSnapToTickEnabled="True" 
                                        Value="{Binding ComboSize}" Margin="0,8,0,0"/>
                                    </StackPanel>

                                    <StackPanel Margin="0,0,0,15">
                                        <TextBlock Text="MAX RESULTS" FontSize="11" FontWeight="Bold" Foreground="#666" Margin="0,0,0,5"/>
                                        <TextBox Text="{Binding MaxResult, UpdateSourceTrigger=LostFocus}" PreviewTextInput="NumberValidationTextBox" DataObject.Pasting="OnPaste" IsEnabled="{Binding CanEditResultCount}" Padding="5" FontSize="14" FontWeight="SemiBold"/>
                                    </StackPanel>

                                    <CheckBox IsChecked="{Binding IsDisjointMode}" Margin="0,10,0,20">
                                        <StackPanel>
                                            <TextBlock Text="Use Disjoint Mode" FontWeight="Bold"/>
                                            <TextBlock Text="Each tag appears only once in results (take several minutes)" FontSize="10" Foreground="Gray" TextWrapping="Wrap"/>
                                        </StackPanel>
                                    </CheckBox>
                                    <Separator Margin="0,0,0,20"/>
                                </StackPanel>
                            </ScrollViewer>

                        </Grid>
                    </Border>
                </Grid>
            </Grid>
        </DockPanel>
        <Grid Background="#CC0A0A0F" 
          Visibility="{Binding IsBusy, Converter={StaticResource BoolToVis}}"
          IsHitTestVisible="True">

            <Grid.Resources>
                <LinearGradientBrush x:Key="FinBrush" StartPoint="0,0" EndPoint="1,1">
                    <GradientStop Color="#AADCF7" Offset="1"/>
                    <GradientStop Color="#32369B" Offset="0"/>
                </LinearGradientBrush>

                <LinearGradientBrush x:Key="BodyBrush" StartPoint="0,0" EndPoint="0,1">
                    <GradientStop Color="#AADCF7" Offset="0"/>
                    <GradientStop Color="#363795" Offset="1"/>
                </LinearGradientBrush>

                <LinearGradientBrush x:Key="FlameBrush" StartPoint="0,0" EndPoint="0,1">
                    <GradientStop Color="#FFFFD5" Offset="0"/>
                    <GradientStop Color="#FF6F59" Offset="1"/>
                </LinearGradientBrush>

                <BooleanToVisibilityConverter x:Key="BoolToVis"/>
            </Grid.Resources>

            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">

                <Viewbox Width="250" Height="250" HorizontalAlignment="Center" VerticalAlignment="Center">
                    <Canvas Width="800" Height="800">

                        <Ellipse Canvas.Left="153" Canvas.Top="153" Width="494" Height="494" Fill="#F1F3F5"/>
                        <Ellipse Canvas.Left="526" Canvas.Top="186" Width="24" Height="24" Fill="#ADB2CF"/>
                        <Ellipse Canvas.Left="241" Canvas.Top="277" Width="14" Height="14" Fill="#ADB2CF"/>
                        <Polygon Points="572,360 577,382 600,388 577,393 572,416 566,393 544,388 566,382" Fill="#ADB2CF"/>

                        <Canvas x:Name="RocketGroup">
                            <Canvas.RenderTransform>
                                <TranslateTransform x:Name="RocketFloat" Y="0"/>
                            </Canvas.RenderTransform>
                            <Canvas.Triggers>
                                <EventTrigger RoutedEvent="Loaded">
                                    <BeginStoryboard>
                                        <Storyboard>
                                            <DoubleAnimation Storyboard.TargetName="RocketFloat" Storyboard.TargetProperty="Y" 
                                             From="-15" To="15" Duration="0:0:3" AutoReverse="True" RepeatBehavior="Forever">
                                                <DoubleAnimation.EasingFunction>
                                                    <SineEase EasingMode="EaseInOut"/>
                                                </DoubleAnimation.EasingFunction>
                                            </DoubleAnimation>
                                        </Storyboard>
                                    </BeginStoryboard>
                                </EventTrigger>
                            </Canvas.Triggers>

                            <Path Data="M430,530 s44,38 -30,162 c-74,-123 -30,-162 -30,-162" Fill="{StaticResource FlameBrush}" Opacity="0.8">
                                <Path.Triggers>
                                    <EventTrigger RoutedEvent="Loaded">
                                        <BeginStoryboard>
                                            <Storyboard>
                                                <DoubleAnimation Storyboard.TargetProperty="Opacity" From="0.5" To="0.9" Duration="0:0:0.5" AutoReverse="True" RepeatBehavior="Forever"/>
                                            </Storyboard>
                                        </BeginStoryboard>
                                    </EventTrigger>
                                </Path.Triggers>
                            </Path>

                            <Polygon Points="474,371 544,444 510,643 485,513 427,483" Fill="{StaticResource FinBrush}"/>
                            <Polygon Points="325,371 255,444 289,643 314,513 372,483" Fill="{StaticResource FinBrush}"/>

                            <Path Data="M442,515 S480,470 480,330 c0-50 4-158 -80-220 c-84,61 -80,170 -80,220 0,140 37,185 37,185 Z" Fill="{StaticResource BodyBrush}"/>

                            <Path Data="M442,513 l-4,9 c-1.4,3.1 -5,6 -8.4,6 H370 c-3.4,0 -7,-2.8 -8.4,-6 l-4,-9 Z" Fill="#3F45A5"/>

                            <Ellipse Canvas.Left="350" Canvas.Top="224" Width="100" Height="100" Fill="#AADCF7"/>
                            <Ellipse Canvas.Left="359" Canvas.Top="233" Width="82" Height="82" Fill="#110B39"/>
                            <Path Data="M401,310 a40.5,40.5 0 0 1 -37,-55 a41,41 0 1 0 76,25 a40.5,40.5 0 0 1 -39,30 Z" Fill="White" Opacity="0.2"/>
                        </Canvas>
                    </Canvas>
                </Viewbox>


                <TextBlock Text="N.I.C.E. ENGINE COMPUTING" Foreground="White" FontSize="28" FontWeight="Black" HorizontalAlignment="Center">
                    <TextBlock.Effect>
                        <DropShadowEffect BlurRadius="10" Color="#007ACC" ShadowDepth="0"/>
                    </TextBlock.Effect>
                </TextBlock>

                <TextBlock Text="Analyzing orbital trajectories and tag synergies..." Foreground="#AAA" FontSize="14" Margin="0,10,0,0" HorizontalAlignment="Center"/>

                <TextBlock Text="{Binding ComputationStatus}" Foreground="#007ACC" FontSize="12" Margin="0,30,0,0" HorizontalAlignment="Center" FontWeight="Bold"/>
            </StackPanel>
            <Button Command="{Binding ToggleLogCommand}" 
            VerticalAlignment="Bottom" 
            HorizontalAlignment="Left"
            Width="310" Height="60" 
            Margin="15,0,0,40">
                <Button.Style>
                    <Style TargetType="Button" BasedOn="{StaticResource NiceButtonStyle}">
                        <Setter Property="Content" Value="VIEW COMPUTATION DETAILS"/>
                        <Setter Property="Background" Value="#007ACC"/>
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding IsLogVisible}" Value="True">
                                <Setter Property="Content" Value="CLOSE COMPUTATION DETAILS"/>
                                <Setter Property="Background" Value="#D9534F"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </Button.Style>
            </Button>
        </Grid>
        <Grid VerticalAlignment="Bottom" HorizontalAlignment="Right" Margin="0,0,15,40" 
          Width="310" Height="60"
          Panel.ZIndex="100">

            <Button Style="{StaticResource ComputeButtonStyle}" Command="{Binding ComputeCommand}" Height="60" Margin="0,-10,0,10"/>
        </Grid>
    </Grid>
</Window>