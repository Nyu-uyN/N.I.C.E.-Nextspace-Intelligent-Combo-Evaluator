<Window x:Class="N.I.C.E.___Nextspace_Intelligent_Combo_Evaluator.View.TimWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="clr-namespace:N.I.C.E.___Nextspace_Intelligent_Combo_Evaluator.ViewModel"
        mc:Ignorable="d"
        Title="T.I.M. - Tag Incompatibility Manager" 
        Height="800" Width="1400"
        WindowStartupLocation="CenterOwner"
        Background="#F5F5F5">

    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis"/>
        <LinearGradientBrush x:Key="FinBrush" StartPoint="0,0" EndPoint="1,1">
            <GradientStop Color="#AADCF7" Offset="1"/>
            <GradientStop Color="#32369B" Offset="0"/>
        </LinearGradientBrush>

        <LinearGradientBrush x:Key="BodyBrush" StartPoint="0,0" EndPoint="0,1">
            <GradientStop Color="#AADCF7" Offset="0"/>
            <GradientStop Color="#363795" Offset="1"/>
        </LinearGradientBrush>

        <LinearGradientBrush x:Key="FlameBrush" StartPoint="0,0" EndPoint="0,1">
            <GradientStop Color="#FFFFD5" Offset="0"/>
            <GradientStop Color="#FF6F59" Offset="1"/>
        </LinearGradientBrush>
        <SolidColorBrush x:Key="Brush.Core.Compatible" Color="#F0F9F0"/>
        <SolidColorBrush x:Key="Brush.Core.Incompatible" Color="#FFF5F5"/>
        <SolidColorBrush x:Key="Brush.Override.Compatible" Color="#DFF0D8"/>
        <SolidColorBrush x:Key="Brush.Override.Incompatible" Color="#F2DEDE"/>
        <SolidColorBrush x:Key="Text.Core" Color="#555555"/>
        <SolidColorBrush x:Key="Text.Override" Color="#A94442"/>
    </Window.Resources>
    <Grid>
        <Grid Margin="15">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="450"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <Grid.RowDefinitions>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <GroupBox Header="MASTER TAG POOL" Grid.Column="0" Margin="0,0,10,0" Padding="5">
            <DockPanel>

                <Border DockPanel.Dock="Top" Background="White" BorderBrush="#CCC" BorderThickness="1" Margin="0,0,0,10" Padding="5">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="🔍" VerticalAlignment="Center" Margin="5,0" Foreground="Gray"/>

                        <TextBox Grid.Column="1" 
                                 Text="{Binding SearchTextLeft, UpdateSourceTrigger=PropertyChanged}" 
                                 BorderThickness="0" 
                                 VerticalContentAlignment="Center" 
                                 FontSize="13"/>

                        <TextBlock Grid.Column="1" Text="Search ID or Name..." 
                                   IsHitTestVisible="False" Foreground="Silver" 
                                   VerticalAlignment="Center" Margin="2,0,0,0">
                            <TextBlock.Style>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding SearchTextLeft}" Value="">
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding SearchTextLeft}" Value="{x:Null}">
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>
                    </Grid>
                </Border>

                <DataGrid ItemsSource="{Binding MasterTags}" 
                          SelectedItem="{Binding SelectedMasterTag}"
                          VirtualizingStackPanel.IsVirtualizing="True"
                          VirtualizingStackPanel.VirtualizationMode="Recycling"
                          EnableRowVirtualization="True"
                          AutoGenerateColumns="False" 
                          IsReadOnly="True" 
                          SelectionMode="Single"
                          GridLinesVisibility="Horizontal"
                          BorderThickness="1" BorderBrush="#DDD">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="ID" Binding="{Binding Index}" Width="50"/>
                        <DataGridTextColumn Header="NAME" Binding="{Binding Name}" Width="100" FontWeight="SemiBold"/>
                        <DataGridTextColumn Header="DESCRIPTION" Binding="{Binding Description}" Width="*"/>
                    </DataGrid.Columns>
                </DataGrid>
            </DockPanel>
        </GroupBox>

        <GroupBox Header="TAG COMPATIBILITY STATUS" Grid.Column="1" Padding="5">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <Border Grid.Row="0" Background="#EFEFEF" Padding="10" Margin="0,0,0,10" CornerRadius="3">
                    <DockPanel>
                        <StackPanel DockPanel.Dock="Left">
                            <TextBlock Text="SELECTED TAG CONTEXT" FontSize="10" Foreground="Gray" FontWeight="Bold"/>
                            <TextBlock Text="{Binding SelectedMasterTag.Name}" FontSize="24" FontWeight="Black" Foreground="#007ACC"/>
                            <TextBlock Text="{Binding SelectedMasterTag.Description}" FontStyle="Italic" TextWrapping="Wrap" MaxWidth="600" Margin="0,5,0,0"/>
                        </StackPanel>

                        <StackPanel DockPanel.Dock="Right" HorizontalAlignment="Right" VerticalAlignment="Center">
                            <Button Content="Reset Tag to Default" 
                                    Command="{Binding RevertTagToDefaultCommand}" 
                                    Margin="0,0,0,5" Padding="10,4" FontSize="11"
                                    ToolTip="Revert this tag's rules to factory settings (tags.json)"/>
                            <Button Content="Revert Session Changes" 
                                    Command="{Binding RevertTagToSavedCommand}" 
                                    Padding="10,4" FontSize="11"
                                    ToolTip="Discard changes made to this tag since opening T.I.M."/>
                        </StackPanel>
                    </DockPanel>
                </Border>

                <Border Grid.Row="1" Background="#E0E0E0" Padding="8" Margin="0,0,0,5" CornerRadius="3">
                    <DockPanel LastChildFill="False">
                        <TextBlock Text="FILTER VIEW:" FontWeight="Bold" VerticalAlignment="Center" Margin="0,0,10,0"/>

                        <RadioButton Content="Show All" IsChecked="True" GroupName="FilterGroup"
                                     Command="{Binding ChangeFilterCommand}" CommandParameter="ShowAll" 
                                     Margin="0,0,15,0" VerticalAlignment="Center"/>

                        <RadioButton Content="Compatible Only" GroupName="FilterGroup"
                                     Command="{Binding ChangeFilterCommand}" CommandParameter="OnlyCompatible" 
                                     Margin="0,0,15,0" VerticalAlignment="Center"/>

                        <RadioButton Content="Incompatible Only" GroupName="FilterGroup"
                                     Command="{Binding ChangeFilterCommand}" CommandParameter="OnlyIncompatible" 
                                     Margin="0,0,15,0" VerticalAlignment="Center"/>

                        <RadioButton Content="Pending Changes (*)" GroupName="FilterGroup"
                                     Command="{Binding ChangeFilterCommand}" CommandParameter="OnlyPending" 
                                     Foreground="#D9534F" FontWeight="Bold"
                                     Margin="0,0,20,0" VerticalAlignment="Center"/>

                        <Separator Style="{StaticResource {x:Static ToolBar.SeparatorStyleKey}}" Margin="0,0,20,0"/>

                        <Grid Width="200">
                            <TextBox Text="{Binding SearchTextRight, UpdateSourceTrigger=PropertyChanged}" 
                                     VerticalContentAlignment="Center" Padding="5"/>
                            <TextBlock Text="Search Target ID/Name..." 
                                       IsHitTestVisible="False" Foreground="Gray" 
                                       VerticalAlignment="Center" Margin="8,0,0,0">
                                <TextBlock.Style>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding SearchTextRight}" Value="">
                                                <Setter Property="Visibility" Value="Visible"/>
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding SearchTextRight}" Value="{x:Null}">
                                                <Setter Property="Visibility" Value="Visible"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBlock.Style>
                            </TextBlock>
                        </Grid>
                    </DockPanel>
                </Border>

                <DataGrid Grid.Row="2" 
                          ItemsSource="{Binding RelationGrid}" 
                          VirtualizingStackPanel.IsVirtualizing="True"
                          VirtualizingStackPanel.VirtualizationMode="Recycling"
                          EnableRowVirtualization="True"
                          AutoGenerateColumns="False" 
                          IsReadOnly="True"
                          GridLinesVisibility="Horizontal"
                          HeadersVisibility="Column"
                          BorderThickness="1" BorderBrush="#CCC">

                    <DataGrid.RowStyle>
                        <Style TargetType="DataGridRow">
                            <Setter Property="Background" Value="{StaticResource Brush.Core.Compatible}"/>
                            <Style.Triggers>
                                <MultiDataTrigger>
                                    <MultiDataTrigger.Conditions>
                                        <Condition Binding="{Binding IsIncompatible}" Value="True"/>
                                        <Condition Binding="{Binding IsDifferentFromDefault}" Value="False"/>
                                    </MultiDataTrigger.Conditions>
                                    <Setter Property="Background" Value="{StaticResource Brush.Core.Incompatible}"/>
                                </MultiDataTrigger>

                                <MultiDataTrigger>
                                    <MultiDataTrigger.Conditions>
                                        <Condition Binding="{Binding IsIncompatible}" Value="False"/>
                                        <Condition Binding="{Binding IsDifferentFromDefault}" Value="True"/>
                                    </MultiDataTrigger.Conditions>
                                    <Setter Property="Background" Value="{StaticResource Brush.Override.Compatible}"/>
                                    <Setter Property="FontWeight" Value="SemiBold"/>
                                </MultiDataTrigger>

                                <MultiDataTrigger>
                                    <MultiDataTrigger.Conditions>
                                        <Condition Binding="{Binding IsIncompatible}" Value="True"/>
                                        <Condition Binding="{Binding IsDifferentFromDefault}" Value="True"/>
                                    </MultiDataTrigger.Conditions>
                                    <Setter Property="Background" Value="{StaticResource Brush.Override.Incompatible}"/>
                                    <Setter Property="FontWeight" Value="SemiBold"/>
                                </MultiDataTrigger>
                            </Style.Triggers>
                        </Style>
                    </DataGrid.RowStyle>

                    <DataGrid.Columns>
                        <DataGridTextColumn Header="ID" Binding="{Binding Target.Index}" Width="50"/>
                        <DataGridTextColumn Header="TARGET NAME" Binding="{Binding Target.Name}" Width="180"/>

                        <DataGridTextColumn Header="DESCRIPTION" Binding="{Binding Target.Description}" Width="*">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="TextTrimming" Value="CharacterEllipsis"/>
                                    <Setter Property="VerticalAlignment" Value="Center"/>
                                    <Setter Property="Foreground" Value="Gray"/>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>

                        <DataGridTemplateColumn Header="STATUS" Width="140">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding StatusDisplay}" 
                                               VerticalAlignment="Center" HorizontalAlignment="Center">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding IsDifferentFromDefault}" Value="True">
                                                        <Setter Property="Foreground" Value="{StaticResource Text.Override}"/>
                                                        <Setter Property="FontWeight" Value="Bold"/>
                                                    </DataTrigger>
                                                    <DataTrigger Binding="{Binding IsDifferentFromDefault}" Value="False">
                                                        <Setter Property="Foreground" Value="{StaticResource Text.Core}"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                    </TextBlock>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>

                        

                        <DataGridTemplateColumn Header="ACTION" Width="100">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <Button Content="TOGGLE" 
                                            Command="{Binding DataContext.ToggleCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                            CommandParameter="{Binding Target.Index}"
                                            Padding="10,2" Margin="2"/>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                    </DataGrid.Columns>
                </DataGrid>
            </Grid>
        </GroupBox>

        <Border Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2" 
                Background="White" Margin="0,15,0,0" Padding="15" 
                BorderBrush="#CCC" BorderThickness="0,1,0,0">
            <DockPanel>
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center" 
                            Visibility="{Binding HasPendingChanges, Converter={StaticResource BoolToVis}}">
                    <TextBlock Text="⚠️" FontSize="16" Margin="0,0,10,0"/>
                    <TextBlock Text="PENDING MODIFICATIONS - SYSTEM RECALCULATION REQUIRED" 
                               FontWeight="Bold" Foreground="#D9534F" VerticalAlignment="Center"/>
                </StackPanel>

                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                    <Button Content="RESET ENTIRE POOL TO DEFAULT" 
                            Command="{Binding ResetAllToDefaultCommand}"
                            Background="#D9534F" Foreground="White"
                            Padding="15,8" Margin="0,0,10,0"
                            ToolTip="Danger: Reverts ALL tags to factory settings."/>

                    <Button Content="DISMISS ALL SESSION CHANGES" 
                            Command="{Binding DismissAllChangesCommand}"
                            Padding="15,8" Margin="0,0,10,0"
                            ToolTip="Reloads the state from the last save."/>

                    <Button Content="COMMIT &amp; RECALCULATE" 
                            Command="{Binding CommitCommand}"
                            Padding="30,8" FontWeight="Black"
                            Background="#007ACC" Foreground="White"
                            IsEnabled="{Binding HasPendingChanges}"
                            ToolTip="Saves overrides and triggers parallel computation."/>
                </StackPanel>
            </DockPanel>
        </Border>
    </Grid>
        <Grid Background="#DD0A0A0F" 
              Visibility="{Binding IsBusy, Converter={StaticResource BoolToVis}}"
              IsHitTestVisible="True"
              Panel.ZIndex="999">

            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">

                <Viewbox Width="200" Height="200" HorizontalAlignment="Center" VerticalAlignment="Center">
                    <Canvas Width="800" Height="800">
                        <Ellipse Canvas.Left="153" Canvas.Top="153" Width="494" Height="494" Fill="#F1F3F5"/>
                        <Ellipse Canvas.Left="526" Canvas.Top="186" Width="24" Height="24" Fill="#ADB2CF"/>
                        <Ellipse Canvas.Left="241" Canvas.Top="277" Width="14" Height="14" Fill="#ADB2CF"/>
                        <Polygon Points="572,360 577,382 600,388 577,393 572,416 566,393 544,388 566,382" Fill="#ADB2CF"/>

                        <Canvas x:Name="RocketGroup">
                            <Canvas.RenderTransform>
                                <TranslateTransform x:Name="RocketFloat" Y="0"/>
                            </Canvas.RenderTransform>
                            <Canvas.Triggers>
                                <EventTrigger RoutedEvent="Loaded">
                                    <BeginStoryboard>
                                        <Storyboard>
                                            <DoubleAnimation Storyboard.TargetName="RocketFloat" Storyboard.TargetProperty="Y" 
                                                             From="-15" To="15" Duration="0:0:3" AutoReverse="True" RepeatBehavior="Forever">
                                                <DoubleAnimation.EasingFunction>
                                                    <SineEase EasingMode="EaseInOut"/>
                                                </DoubleAnimation.EasingFunction>
                                            </DoubleAnimation>
                                        </Storyboard>
                                    </BeginStoryboard>
                                </EventTrigger>
                            </Canvas.Triggers>

                            <Path Data="M430,530 s44,38 -30,162 c-74,-123 -30,-162 -30,-162" Fill="{StaticResource FlameBrush}" Opacity="0.8">
                                <Path.Triggers>
                                    <EventTrigger RoutedEvent="Loaded">
                                        <BeginStoryboard>
                                            <Storyboard>
                                                <DoubleAnimation Storyboard.TargetProperty="Opacity" From="0.5" To="0.9" Duration="0:0:0.5" AutoReverse="True" RepeatBehavior="Forever"/>
                                            </Storyboard>
                                        </BeginStoryboard>
                                    </EventTrigger>
                                </Path.Triggers>
                            </Path>

                            <Polygon Points="474,371 544,444 510,643 485,513 427,483" Fill="{StaticResource FinBrush}"/>
                            <Polygon Points="325,371 255,444 289,643 314,513 372,483" Fill="{StaticResource FinBrush}"/>
                            <Path Data="M442,515 S480,470 480,330 c0-50 4-158 -80-220 c-84,61 -80,170 -80,220 0,140 37,185 37,185 Z" Fill="{StaticResource BodyBrush}"/>
                            <Path Data="M442,513 l-4,9 c-1.4,3.1 -5,6 -8.4,6 H370 c-3.4,0 -7,-2.8 -8.4,-6 l-4,-9 Z" Fill="#3F45A5"/>
                            <Ellipse Canvas.Left="350" Canvas.Top="224" Width="100" Height="100" Fill="#AADCF7"/>
                            <Ellipse Canvas.Left="359" Canvas.Top="233" Width="82" Height="82" Fill="#110B39"/>
                            <Path Data="M401,310 a40.5,40.5 0 0 1 -37,-55 a41,41 0 1 0 76,25 a40.5,40.5 0 0 1 -39,30 Z" Fill="White" Opacity="0.2"/>
                        </Canvas>
                    </Canvas>
                </Viewbox>

                <TextBlock Text="SAVING &amp; RECALCULATING..." Foreground="White" FontSize="24" FontWeight="Black" HorizontalAlignment="Center" Margin="0,20,0,0">
                    <TextBlock.Effect>
                        <DropShadowEffect BlurRadius="10" Color="#007ACC" ShadowDepth="0"/>
                    </TextBlock.Effect>
                </TextBlock>

                <TextBlock Text="Please wait while max potential scores are recalculated..." Foreground="#DDD" FontSize="14" Margin="0,10,0,0" HorizontalAlignment="Center"/>
            </StackPanel>
        </Grid>
    </Grid>
</Window>