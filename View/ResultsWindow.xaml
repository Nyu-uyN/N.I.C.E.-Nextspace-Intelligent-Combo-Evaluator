<Window x:Class="N.I.C.E.___Nextspace_Intelligent_Combo_Evaluator.View.ResultsWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="clr-namespace:N.I.C.E.___Nextspace_Intelligent_Combo_Evaluator.ViewModel"
        xmlns:model="clr-namespace:N.I.C.E.___Nextspace_Intelligent_Combo_Evaluator.Model"
        xmlns:sys="clr-namespace:System;assembly=mscorlib"
        mc:Ignorable="d"
        Title="{Binding WindowTitle}" Height="900" Width="1500"
        WindowStartupLocation="CenterScreen">

    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis"/>
        <vm:RarityColorConverter x:Key="RarityColorConverter"/>

        <DataTemplate x:Key="TagChipTemplate" DataType="{x:Type vm:TagViewModel}">
            <Border CornerRadius="3" Padding="6,2" Margin="0,0,5,3" BorderThickness="1" BorderBrush="#999">
                <Border.Background>
                    <Binding Converter="{StaticResource RarityColorConverter}"/>
                </Border.Background>
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="{Binding Index, StringFormat='[{0}] '}" FontSize="10" Foreground="#444" VerticalAlignment="Center"/>
                    <TextBlock Text="{Binding Name}" FontWeight="SemiBold" Foreground="#111" VerticalAlignment="Center"/>
                </StackPanel>
            </Border>
        </DataTemplate>

        <DataTemplate x:Key="ComboDetailTemplate" DataType="{x:Type vm:ComboViewModel}">
            <StackPanel Margin="5">
                <Border Background="#FDFDFD" BorderBrush="#28a745" BorderThickness="0,0,0,4" Padding="15" Margin="0,0,0,10">
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                        <TextBlock Text="COMBO SCORE" FontSize="14" FontWeight="Black" Foreground="#666" VerticalAlignment="Center" Margin="0,0,15,0"/>
                        <TextBlock Text="{Binding Score, StringFormat=N0}" FontSize="36" FontWeight="Black" Foreground="#28a745"/>
                    </StackPanel>
                </Border>

                <TextBlock Text="TAGS COMPOSITION" FontSize="11" FontWeight="Bold" Foreground="#999" Margin="5,5,0,5"/>
                <Border Background="White" BorderBrush="#DDD" BorderThickness="1" CornerRadius="4" Padding="10">
                    <ItemsControl ItemsSource="{Binding TagVMs}" ItemTemplate="{StaticResource TagChipTemplate}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <WrapPanel/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                    </ItemsControl>
                </Border>

                <TextBlock Text="ACTIVE SYNERGIES" FontSize="11" FontWeight="Bold" Foreground="#999" Margin="5,20,0,5"/>
                <Border Background="White" BorderBrush="#DDD" BorderThickness="1" CornerRadius="4" Padding="12">
                    <ItemsControl ItemsSource="{Binding Synergies}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Grid Margin="0,4">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="130"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="{Binding VisualBars}" FontFamily="Consolas" Foreground="#28a745" FontSize="14" Margin="0,0,15,0"/>
                                    <TextBlock Grid.Column="1" Text="{Binding CategoryName}" FontWeight="Bold" VerticalAlignment="Center"/>
                                    <TextBlock Grid.Column="2" Text="{Binding Count, StringFormat='({0} tags)'}" Foreground="Gray" FontSize="11" VerticalAlignment="Center"/>
                                    <Border Grid.Column="3" Background="#E3F2FD" CornerRadius="4" Padding="8,2">
                                        <TextBlock Text="{Binding Multiplier, StringFormat='x{0}'}" Foreground="#1976D2" FontWeight="Black"/>
                                    </Border>
                                </Grid>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </Border>

                <TextBlock Text="MATHEMATICAL BREAKDOWN" FontSize="11" FontWeight="Bold" Foreground="#999" Margin="5,20,0,5"/>
                <Border Background="#F8F9FA" BorderBrush="#CCC" BorderThickness="1" CornerRadius="4" Padding="20">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="1.2*"/>
                        </Grid.ColumnDefinitions>
                        <StackPanel Grid.Column="0" HorizontalAlignment="Center">
                            <TextBlock Text="BASE SUM" FontSize="9" Foreground="#888" HorizontalAlignment="Center"/>
                            <TextBlock Text="{Binding BaseSubs, StringFormat=N0}" FontSize="20" FontWeight="Bold" Foreground="#444"/>
                        </StackPanel>
                        <TextBlock Grid.Column="1" Text="×" FontSize="28" Foreground="#BBB" VerticalAlignment="Center" Margin="15,0"/>
                        <StackPanel Grid.Column="2" HorizontalAlignment="Center">
                            <TextBlock Text="EFFICIENCY" FontSize="9" Foreground="#888" HorizontalAlignment="Center"/>
                            <TextBlock Text="{Binding GlobalMultiplier, StringFormat='x{0:N2}'}" FontSize="20" FontWeight="Bold" Foreground="#007ACC"/>
                        </StackPanel>
                        <TextBlock Grid.Column="3" Text="=" FontSize="28" Foreground="#BBB" VerticalAlignment="Center" Margin="15,0"/>
                        <Border Grid.Column="4" Background="#28a745" CornerRadius="4" Padding="15,8">
                            <TextBlock Text="{Binding Score, StringFormat=N0}" FontSize="22" FontWeight="Black" Foreground="White" HorizontalAlignment="Center"/>
                        </Border>
                    </Grid>
                </Border>
            </StackPanel>
        </DataTemplate>
    </Window.Resources>

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="750"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <Grid Grid.Column="0" Margin="10">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <TextBlock Grid.Row="0" Text="RANKING" FontSize="16" FontWeight="Black" Margin="5,0,0,10"/>

            <DataGrid Grid.Row="1" ItemsSource="{Binding Results}" SelectedItem="{Binding SelectedCombo}"
                      AutoGenerateColumns="False" IsReadOnly="True" HeadersVisibility="Column"
                      GridLinesVisibility="Horizontal" BorderThickness="1" BorderBrush="#CCC">
                <DataGrid.Columns>
                    <DataGridTextColumn Header="Rank" Binding="{Binding Rank}" Width="50">
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="TextBlock">
                                <Setter Property="HorizontalAlignment" Value="Center"/>
                                <Setter Property="VerticalAlignment" Value="Center"/>
                                <Setter Property="Foreground" Value="#888"/>
                                <Setter Property="FontWeight" Value="Bold"/>
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>
                    
                    <DataGridTextColumn Header="Score" Binding="{Binding Score, StringFormat=N0}" Width="120">
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="TextBlock">
                                <Setter Property="FontWeight" Value="Bold"/>
                                <Setter Property="Foreground" Value="#28a745"/>
                                <Setter Property="HorizontalAlignment" Value="Right"/>
                                <Setter Property="VerticalAlignment" Value="Center"/>
                                <Setter Property="Margin" Value="0,0,10,0"/>
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>
                    <DataGridTemplateColumn Header="Composition" Width="*">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <ItemsControl ItemsSource="{Binding TagVMs}" ItemTemplate="{StaticResource TagChipTemplate}" Margin="2">
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <WrapPanel/>
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>
                                </ItemsControl>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                </DataGrid.Columns>
            </DataGrid>
        </Grid>

        <Grid Grid.Column="1" Background="#F0F0F0">
            <Grid.RowDefinitions>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <ScrollViewer Grid.Row="0" VerticalScrollBarVisibility="Auto" Padding="15">
                <StackPanel>
                    <Border Visibility="{Binding IsLogVisible, Converter={StaticResource BoolToVis}}" 
                    Background="White" BorderBrush="#CCC" BorderThickness="1" 
                    Margin="0,0,0,20" CornerRadius="4">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="300"/>
                            </Grid.RowDefinitions>

                            <Border Background="#F8F9FA" Padding="10" BorderBrush="#DDD" BorderThickness="0,0,0,1">
                                <DockPanel>
                                    <Button DockPanel.Dock="Right" Content="SAVE TO .LOG" 
                                    Command="{Binding SaveLogCommand}" 
                                    Padding="10,2" FontSize="10" Background="White"/>
                                    <TextBlock Text="COMPUTATION LOGS" FontWeight="Black" FontSize="11" Foreground="#666"/>
                                </DockPanel>
                            </Border>

                            <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" Background="#FCFCFC">
                                <ItemsControl ItemsSource="{Binding Logs}" Margin="10">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Grid Margin="0,1">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="85"/>
                                                    <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>
                                                <TextBlock Text="{Binding Timestamp}" Foreground="#999" FontFamily="Consolas" FontSize="10"/>
                                                <TextBlock Grid.Column="1" Text="{Binding Message}" Foreground="#333" FontFamily="Consolas" FontSize="11" TextWrapping="Wrap"/>
                                            </Grid>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </ScrollViewer>
                        </Grid>
                    </Border>

                    <DockPanel LastChildFill="True" Margin="5,0,5,15">
                        <Button DockPanel.Dock="Right" Content="📌 PIN TO COMPARE" Command="{Binding PinSelectionCommand}" Padding="15,7" FontWeight="Bold"/>
                        <TextBlock Text="DETAILED ANALYSIS" FontWeight="Black" FontSize="14" VerticalAlignment="Center"/>
                    </DockPanel>

                    <ContentControl Content="{Binding SelectedCombo}" ContentTemplate="{StaticResource ComboDetailTemplate}"/>

                    <StackPanel Margin="0,30,0,0" Visibility="{Binding HasPins, Converter={StaticResource BoolToVis}}">
                        <Separator Margin="0,0,0,20" Background="#BBB"/>
                        <TextBlock Text="COMPARISON OVERLAY" FontWeight="Black" FontSize="14" Foreground="#007ACC" Margin="5,0,0,15"/>
                        <ItemsControl ItemsSource="{Binding PinnedCombos}">
                        </ItemsControl>
                    </StackPanel>
                </StackPanel>
            </ScrollViewer>

            <Border Grid.Row="1" Background="White" BorderBrush="#CCC" BorderThickness="0,1,0,0" Padding="15">
                <Grid>
                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                        <TextBlock Text="Computing time: " Foreground="#999" FontStyle="Italic"/>
                        <TextBlock Text="{Binding ExecutionTime}" Foreground="#007ACC" FontWeight="SemiBold" Margin="0,0,15,0"/>

                        <Button Command="{Binding ToggleLogCommand}" 
                        Visibility="{Binding HasLogs, Converter={StaticResource BoolToVis}}"
                        Content="TOGGLE LOGS" Padding="12,4" FontSize="11" FontWeight="Bold"
                        Background="Transparent" Foreground="#007ACC" BorderBrush="#007ACC" BorderThickness="1">
                            <Button.Style>
                                <Style TargetType="Button">
                                    <Style.Triggers>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter Property="Background" Value="#F0F7FF"/>
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                        </Button>
                    </StackPanel>

                    <Button HorizontalAlignment="Right" Content="EXPORT TO .TXT" 
                    Command="{Binding ExportCommand}" Padding="35,12" 
                    Background="#007ACC" Foreground="White" FontWeight="Bold"/>
                </Grid>
            </Border>
        </Grid>
    </Grid>
</Window>